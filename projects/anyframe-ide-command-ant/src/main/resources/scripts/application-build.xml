<?xml version="1.0"?>
<project name="Anyframe Application Build ANT" default="build" basedir="${basedir}">

    <property file="${basedir}/META-INF/project.mf"/>
	<property file="${anyframe.home}/ide/cli/scripts/project-build.properties" />
	<import file="${anyframeHome}/ide/cli/scripts/anyframe-path.xml" />
	<import file="${anyframeHome}/ide/cli/scripts/anyframe-taskdef.xml" />

	<path id="jetty.plugin.classpath">
		<fileset dir="${anyframeHome}/ide/ant/etc/jetty" includes="*.jar" />
	</path>

	<taskdef classpathref="jetty.plugin.classpath" resource="tasks.properties" loaderref="jetty.loader" />
	<typedef name="selectChannelConnector" classname="org.mortbay.jetty.nio.SelectChannelConnector" classpathref="jetty.plugin.classpath" loaderref="jetty.loader" />

	<target name="clean">
		<if>
			<equals arg1="$${clean}" arg2="${clean}" />
			<then>
				<property name="clean" value="false" />
			</then>
		</if>
		<if>
			<equals arg1="${clean}" arg2="true" />
			<then>
				<delete dir="${project.home}/dist" includeemptydirs="true" />
				<mkdir dir="${project.home}/dist" />
			</then>
		</if>
	</target>

	<target name="dist">
		<if>
			<equals arg1="$${clean}" arg2="${clean}" />
			<then>
				<property name="clean" value="false" />
			</then>
		</if>
		<if>
			<equals arg1="${clean}" arg2="true" />
			<then>
				<ant antfile="build.xml" dir="${project.home}" target="shared:clean" />
				<ant antfile="build.xml" dir="${project.home}" />
			</then>
			<else>
        <ant antfile="build.xml" dir="${project.home}" />
			</else>
		</if>

	</target>

	<target name="war">
		<if>
			<equals arg1="${project.type}" arg2="service" />
			<then>
				<echo>Fail to make a web application because you don't have a web type project.</echo>
			</then>
			<else>	
    		<delete dir="${basedir}/dist/${web.context.path}" includeemptydirs="true" />
    		<!-- make web application folder -->
    		<copy todir="${basedir}/dist/${web.context.path}" overwrite="true">
    			<fileset dir="${project.home}/src/main/webapp">
    				<include name="**/*.*" />
    			</fileset>
    		</copy>
    		<if><equals arg1="$${deploy}" arg2="${deploy}" />
    			  <then><property name="deploy" value="class" /></then>
    		</if>
        <if><equals arg1="${deploy}" arg2="jar" />
						<then>
							<delete includeemptydirs="true">
								<fileset dir="${basedir}/dist/${web.context.path}/WEB-INF/classes">
									<exclude name="**/displaytag.properties" />
									<exclude name="**/log4j.xml" />
									<exclude name="**/META-INF/*.*" />
								</fileset>
							</delete>				
          		<copy todir="${basedir}/dist/${web.context.path}/WEB-INF/lib">
          			<fileset dir="${basedir}/target/temp/instrlib/">
          				<include name="**/${project.name}-${project.version}.jar" />
          			</fileset>
          		</copy>									
							<antcall target="makewar" />
						</then>
					<elseif>
						<equals arg1="${deploy}" arg2="class" />
						<then>
								<delete includeemptydirs="true" failonerror="false">
										<fileset dir="${basedir}/dist/${web.context.path}/WEB-INF/lib" includes="**/{project.name}-*.jar" />
								</delete>
 							  <antcall target="makewar" />
						</then>
					</elseif>
					<else>
						<echo>Fail to make a web application. You need more arguments.(-deploy [jar/class])</echo>
					</else>
				</if>
		</else>
	 </if>
	</target>

	<target name="makewar">
		<!-- make war file -->
		<if>
			<equals arg1="${war}" arg2="true" />
			<then>
				<war destfile="${basedir}/dist/${web.context.path}.war" webxml="${web.src.dir}/WEB-INF/web.xml">
			        <fileset dir="${web.src.dir}">
				        <include name="**/*.*" />
			        </fileset>
		        </war>
				<echo>makewar done.</echo>
			</then>
		</if>
	</target>

	<target name="jettyrun">
		<if>
			<equals arg1="${project.type}" arg2="web" />
			<then>	
    		<jetty tempDirectory="${basedir}/dist/jetty-temp">
    			<connectors>
    				<selectChannelConnector port="8080" />
    			</connectors>
    			<webApp name="${web.context.path}" warfile="${basedir}/dist/${web.context.path}" contextpath="/${web.context.path}" />
    		  <systemProperties>
            <systemProperty name="log4jdbc.drivers" value="com.sybase.jdbc3.jdbc.SybDriver,Altibase.jdbc.driver.AltibaseDriver" />
          </systemProperties>
    		</jetty>
    	</then>
    	<else><echo>Fail to run a web application because you don't have a web type project.</echo>
    	</else>
    </if>
	</target>

	<!--============ Anyframe Gen Command tartgets ============ -->

	<target name="build" depends="clean, dist, war" />

	<target name="run" depends="clean, dist, war">
		<antcall target="jettyrun" />
	</target>

</project>
